<% layout("Layouts/boilerplate") %>
<body class="bg-light">
  <div class="box py-2 ">
        <h2 class="mb-2 text-center bold">Details</h2>
        <div class="details">
            <p><b>Course:</b> <%- courseName %></p>
            <p><b>Batch:</b> <%- batchName.slice(14,18) %></p>
        </div>
        <div class="details">
            <p><b>Semester:</b> <%- semester %></p>
        </div>
        <div class="details">
            <p><b>Subject:</b> <%- subject %></p>
        </div>
        <div class="details">
            <p><b>Faculty:</b> <%- facultyName %></p>
        </div>
  </div>

  <div class="container-fluid mt-3">
    <form id="attendance-form">
      <div class="table-responsive">
        <div class="form-check form-switch d-flex justify-content-center mb-3">
          <input class="form-check-input" type="checkbox" id="markAllPresent" onchange="toggleAllPresent(this)">
          <label class="form-check-label ms-2" for="markAllPresent">Mark All Present</label>
        </div>

        <table class="table table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>Sno</th>
              <th>Name</th>
              <th>Roll No</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% let count = 1; const today = new Date().toISOString().slice(0, 10); %>
            <% data.forEach(student => {
                const subj = student.subjects?.[subject] || {};
                const isPresent = subj.presentDates?.includes(today);
                const isAbsent = subj.absentDates?.includes(today);
            %>
              <tr>
                <td><%= count++ %></td>
                <td><%= student.name %></td>
                <td><%= student.roll_no %></td>
                <td>
                  <div class="btn-group">
                    <button type="button" class="btn btn-toggle present <%= isPresent ? 'active' : '' %>" onclick="markStatus(this)">Present</button>
                    <button type="button" class="btn btn-toggle absent <%= isAbsent ? 'active' : '' %>" onclick="markStatus(this)">Absent</button>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <div class="text-center mt-3">
        <button type="submit" class="btn btn-success px-4">Submit Attendance</button>
      </div>
    </form> <br>
  </div>

  <script>
    function markStatus(button) {
      const group = button.closest(".btn-group");
      group.querySelectorAll(".btn-toggle").forEach(btn => btn.classList.remove("active"));
      button.classList.add("active");
    }

    document.getElementById("attendance-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const attendanceData = [];

      document.querySelectorAll("tbody tr").forEach(row => {
        const name = row.cells[1].textContent.trim();
        const rollNo = row.cells[2].textContent.trim();
        const presentBtn = row.querySelector(".btn-toggle.present");
        const absentBtn = row.querySelector(".btn-toggle.absent");

        const isPresent = presentBtn.classList.contains("active");
        const isAbsent = absentBtn.classList.contains("active");

        if (isPresent || isAbsent) {
          attendanceData.push({
            name,
            rollNo,
            status: isPresent ? "Present" : "Absent"
          });
        }
      });

      fetch(`/departments/<%= courseName %>/<%= batchName %>/<%= semester %>/<%= subject %>/submit-attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ attendance: attendanceData })
      })
      .then(res => res.json())
      .then(data => {
        if (data.redirectUrl) {
          window.location.href = data.redirectUrl;
        } else {
          alert("Error occurred.");
        }
      });
    });
    function toggleAllPresent(checkbox) {
      const rows = document.querySelectorAll("tbody tr");

      rows.forEach(row => {
        const presentBtn = row.querySelector(".btn-toggle.present");
        const absentBtn = row.querySelector(".btn-toggle.absent");

        // Remove existing active state
        presentBtn.classList.remove("active");
        absentBtn.classList.remove("active");

        if (checkbox.checked) {
          // Mark as Present
          presentBtn.classList.add("active");
        }
      });
    }


  </script>

  <style>
    .btn-toggle.present.active { background-color: #198754; color: white; }
    .btn-toggle.absent.active { background-color: #dc3545; color: white; }
    .btn-toggle { background-color: #f8f9fa; border: 1px solid #ced4da; }
  </style>

</body>
